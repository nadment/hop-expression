////
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
////
= Expression

An expression is a combination of one or more literal values, resolvable identifiers, operators and functions that evaluate to a value.

- Can be parenthesized to control the precedence order.
- Are not case-sensitive, excepted for identifier.
- Optimized immediately after parsing, so the `XYZ+24*60+5` is optimized to `XYZ+1445` and has no impact on performance.

== Comments

Comments are sections of code text to aid readability.


----
// Single line-comment <1>

-- Single line-comment <1>

/* 
 * Multi line	<2>
 * comment /* with nested block */
 */
----

<1> A single line comment begins with two consecutive slash // or hyphen -- characters and ends with a new line.

<2> A multi line comment begins with a slash asterick /* and ends with asterick slash and support nested block comment.

NOTE: A comment is removed when parsing expression before evaluation, therefore has no influence on performance.


== Literals

The simplest kind of expression is a literal that directly represents a constant value.
The following types of literals can be used in expression.

=== String

String literals are always surrounded by single quotes `'`.

----
'test value'
'O''Reilly' <1>
'O' || CHR(13) || 'Reilly' <2>
----
<1> The simplest method to escape single quotes in expression is to use two single quotes.
<2> Use function https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/chr.adoc[CHR] to add special characters.

=== Boolean

Boolean literals are `TRUE` and `FALSE`, with no quotation marks and case-insensitive.
----
TRUE
false
----

=== Integer

Integer literals can be either positive numbers or negative numbers, but do not contain decimals.
----
536
+536
-536
----

=== Number and BigNumber

Literals can be either positive numbers or negative numbers and contain decimals. In addition, scientific notation can be used.
----
24.7
+0.5
-24.7
0.5E-2
1e10
----

NOTE: The decimal point must be represented by a period. A comma is not recognized as a valid decimal point.

=== Binary

Binary can be a sequence of hexadecimal digits with `0x` prefix.
----
0xAE
0x12Ef
0x69048AEFDD010E
----
Or also be composed by 0 and 1 digits with `0b` prefix. 
----
0b1000001011110
----

NOTE:  A leading `0x` is case-sensitive and cannot be written as `0X`, but the case of the digits does not matter.

=== Date

Date literals consist of the word DATE followed by a 10 characters string literal enclosed in apostrophes in a `YYYY-MM-DD` format. 

----
Date '2020-05-18'
----

The parsing is strict and requires months to be less than 12, days to be less than 31.

=== Timestamp


Literal timestamp can includes a time zone offset or a time zone region.

----
Timestamp 'yyyy-mm-dd hh24:mi:ss.ffffff' [AT TIME ZONE  '...']
----
Examples:
----
Timestamp '2020-05-18 23:48'
Timestamp '2020-05-18 23:48:59'
Timestamp '2020-05-18 23:48:59.123456789'
Timestamp '2020-05-18 23:48:59 +05:00'
Timestamp '2020-05-18T23:48:59+0500'
Timestamp '2021-01-01 15:28:59' AT TIME ZONE 'US/Pacific'
----

In some of the timestamp formats, the letter T is used as a separator between the date and time.

== Identifier

Identifiers are the names of fields and is case-sensitive. 

The field name can be enclosed in double quotes `"` such as `"Employee Name"`, this would allow identifiers to contain spaces, other punctuation, and to be keywords.

For example, `YEAR` cannot be used whereas `"YEAR"` can be accepted. 

NOTE: If you wish to include a double quote in an identifier, use another double quote to escape it.

== Operator

Expression supports most of the arithmetic, bitwise, logical and comparison operators.


The operator precedence and associativity, highest to lowest.

[cols="^1,<5,<5", options="header"]
|===
|Associativity|Operator|Description
|left|()|Parenthesis
|left|fx(args...)|Function
|right|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/cast.adoc[::]|Cast
|right|+, -|Positive, Negative
|right|~|Bitwise NOT
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/multiply.adoc[*], https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/divide.adoc[/], %|Multiplication, Division, Modulus
|left|&|Bitwise AND
|left|^|Bitwise exclusive OR
|left|\||Bitwise inclusive OR 
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add.adoc[+], https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/subtract.adoc[-]|Addition, Subtraction
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/concat.adoc[\|\|]|Concatenation
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/in.adoc[IN]|Set membership
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/between.adoc[BETWEEN]|Range containment
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/like.adoc[LIKE], https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/ilike.adoc[ILIKE], https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/rlike.adoc[RLIKE]|Pattern matching
|left|=, >, <, >=, <=, <>, != |Comparison operators
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/is.adoc[IS]|IS [NOT] NULL, IS [NOT] FALSE, IS [NOT] TRUE
|right|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/boolnot.adoc[NOT]|Logical negation 
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/booland.adoc[AND]|Conjunction
|left|https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/boolor.adoc[OR]|Inclusion 
|===

NOTE: An operator on higher levels is evaluated before an operator on a lower level. You can enclose an expression in parentheses to force precedence or clarify precedence, for example, (5 + 2) * 3.

NOTE: When an operator combines expressions of different data types, the data type with the lower precedence is first converted to the data type with the higher precedence. If the conversion isn't a supported implicit conversion, an error is returned. 

== Function

Expression support most of the standard scalar functions.

* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/abs.adoc[ABS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/acos.adoc[ACOS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/acosh.adoc[ACOSH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add_days.adoc[ADD_DAYS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add_hours.adoc[ADD_HOURS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add_minutes.adoc[ADD_MINUTES]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add_months.adoc[ADD_MONTHS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add_seconds.adoc[ADD_SECONDS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add_weeks.adoc[ADD_WEEKS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/add_years.adoc[ADD_YEARS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/ascii.adoc[ASCII]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/asin.adoc[ASIN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/asinh.adoc[ASINH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/atan.adoc[ATAN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/atan2.adoc[ATAN2]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/atanh.adoc[ATANH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/bitand.adoc[BITAND]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/bitget.adoc[BITGET]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/bitnot.adoc[BITNOT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/bitshift.adoc[BITSHIFT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/bitrotate.adoc[BITROTATE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/bitor.adoc[BITOR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/bitxor.adoc[BITXOR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/booland.adoc[BOOLAND]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/boolnot.adoc[BOOLNOT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/boolor.adoc[BOOLOR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/boolxor.adoc[BOOLXOR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/case.adoc[CASE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/cast.adoc[CAST]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/cbrt.adoc[CBRT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/ceil.adoc[CEILING]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/chr.adoc[CHR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/coalesce.adoc[COALESCE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/concat.adoc[CONCAT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/contains.adoc[CONTAINS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/cos.adoc[COS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/cosh.adoc[COSH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/cot.adoc[COT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/date.adoc[DATE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/date_trunc.adoc[DATE_TRUNC]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/day.adoc[DAY]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/dayname.adoc[DAYNAME]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/dayofweek.adoc[DAYOFWEEK]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/dayofyear.adoc[DAYOFYEAR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/days_between.adoc[DAYS_BETWEEN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/decode.adoc[DECODE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/degrees.adoc[DEGREES]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/difference.adoc[DIFFERENCE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/div0.adoc[DIV0]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/endswith.adoc[ENDSWITH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/equal_null.adoc[EQUAL_NULL]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/exp.adoc[EXP]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/extract.adoc[EXTRACT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/first_day.adoc[FIRST_DAY]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/floor.adoc[FLOOR]
** https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/greatest.adoc[GREATEST]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/hour.adoc[HOUR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/hours_between.adoc[HOURS_BETWEEN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/if.adoc[IF]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/ifnull.adoc[IFNULL]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/initcap.adoc[INITCAP]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/insert.adoc[INSERT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/instr.adoc[INSTR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/isoweek.adoc[ISOWEEK]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/json_object.adoc[JSON_OBJECT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/json_value.adoc[JSON_VALUE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/last_day.adoc[LAST_DAY]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/least.adoc[LEAST]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/left.adoc[LEFT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/length.adoc[LENGTH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/ln.adoc[LN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/log.adoc[LOG]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/log10.adoc[LOG10]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/lower.adoc[LOWER]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/lpad.adoc[LPAD]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/ltrim.adoc[LTRIM]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/md5.adoc[MD5]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/minute.adoc[MINUTE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/minutes_between.adoc[MINUTES_BETWEEN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/mod.adoc[MOD]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/modulus.adoc[MODULUS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/month.adoc[MONTH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/monthname.adoc[MONTHNAME]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/months_between.adoc[MONTHS_BETWEEN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/next_day.adoc[NEXT_DAY]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/now.adoc[NOW]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/nullif.adoc[NULLIF]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/nullifzero.adoc[NULLIFZERO]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/numberformat.adoc[NUMBERFORMAT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/nvl2.adoc[NVL2]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/pi.adoc[PI]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/power.adoc[POWER]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/previous_day.adoc[PREVIOUS_DAY]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/quarter.adoc[QUARTER]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/radians.adoc[RADIANS]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/random.adoc[RANDOM]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/regexp_instr.adoc[REGEXP_INSTR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/regexp_like.adoc[REGEXP_LIKE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/regexp_replace.adoc[REGEXP_REPLACE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/regexp_substr.adoc[REGEXP_SUBSTR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/repeat.adoc[REPEAT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/replace.adoc[REPLACE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/reverse.adoc[REVERSE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/right.adoc[RIGHT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/round.adoc[ROUND]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/rpad.adoc[RPAD]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/rtrim.adoc[RTRIM]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/second.adoc[SECOND]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/seconds_between.adoc[SECONDS_BETWEEN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sha1.adoc[SHA1]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sha256.adoc[SHA256]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sha384.adoc[SHA384]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sha512.adoc[SHA512]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sign.adoc[SIGN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sin.adoc[SIN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sinh.adoc[SINH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/soundex.adoc[SOUNDEX]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/space.adoc[SPACE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/sqrt.adoc[SQRT]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/square.adoc[SQUARE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/startswith.adoc[STARTSWITH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/stringdecode.adoc[STRINGDECODE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/stringencode.adoc[STRINGENCODE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/substring.adoc[SUBSTRING]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/tan.adoc[TAN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/tanh.adoc[TANH]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/to_boolean.adoc[TO_BOOLEAN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/to_char.adoc[TO_CHAR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/to_date.adoc[TO_DATE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/to_number.adoc[TO_NUMBER]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/today.adoc[TODAY]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/translate.adoc[TRANSLATE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/trim.adoc[TRIM]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/truncate.adoc[TRUNCATE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/try.adoc[TRY]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/unicode.adoc[UNICODE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/upper.adoc[UPPER]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/urldecode.adoc[URLDECODE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/urlencode.adoc[URLENCODE]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/uuid.adoc[UUID]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/week.adoc[WEEK]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/year.adoc[YEAR]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/years_between.adoc[YEARS_BETWEEN]
* https://github.com/nadment/hop-expression/blob/master/plugins/src/main/doc/zeroifnull.adoc[ZEROIFNULL]

== Coercion rules

Expression supports both implicit and explicit conversion between data types. Explicit conversion is supported by using the `CAST` function.

* Numeric types can be coerced to a wider numeric type. For example, an INTEGER expression can be coerced to a NUMBER, which can be coerced to a BIGNUMBER.
* A STRING containing a number can be coerced to a numeric type.
* A STRING containing a boolean value can be coerced to a BOOLEAN. Valid boolean values are true, false, yes, no, on, off. Comparison is case-insensitive.
* A STRING containing an ISO-8601 formatted date string can be coerced to TIMESTAMP.


